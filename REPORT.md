# REPORT

## 概要

本プロジェクトでは、ユーザーの電力消費データを集計し、エネルギープロバイダーがこのデータを表示および分析できるよう支援するための Web アプリケーションの開発を行いました。

## 実装内容の一覧

### 1. データモデルの実装

User、Consumption、AggregateUserDailyConsumption のデータモデルを実装しました。

### 2. データの取り込み

CSV ファイルからデータを読み込み、Pandas ライブラリを使用してデータの前処理と整形を行い、Django ORM を使用してデータベースに保存しました。

### 3. ビューの実装

日次集計データの表示(summary)と個別ユーザーの詳細表示(detail)のためのビューを実装しました。

### 4. チャートの表示

チャートの表示には Chart.js を使用して、データの視覚化を実現しました。
また、詳細なデータを表形式で表示しました。

### 5. データの集計

Consumption テーブルから AggregateUserDailyConsumption テーブルへ、集計クエリを使用して、日次の合計消費、30 分間の平均消費のデータを集計しました。

### 6. テストケースの追加

モデル、ビュー、URL パターンのテストケースを追加し、コードの品質を保つためにテストを自動化しました。

## アーキテクチャ

アプリケーションのアーキテクチャは、以下の要素で構成されています。

- コンテナ: Docker
- バックエンド: Python, Django
- フロントエンド: Python, Django
- データベース: SQLite

## 使用したモジュールとライブラリ

- Django: ウェブアプリケーションフレームワーク
- Pandas: データの前処理と整形
- Secrets: 機密性の高い乱数の生成
- Chart.js: フロントエンドでのチャートの表示

## 技術的なアプローチ

### 1. データの整形とインポート

CSV ファイルからデータを読み込んで、データをインポートしました。データの整形に関しては、Pandas ライブラリを使用しました。Django モデルに格納する際には、タイムゾーン情報を含む datetime オブジェクトの生成に注意しました。

### 2. データベースの設計

データベースの設計では、ユーザーごとの日次集計データを高速に取得できるように、データベースのインデックスを最適化しました。また、unique_together 制約(組み合わせの一意性制約)を使用してデータの整合性を保ちました。

### 3. データの集計

バッチ処理を使用してデータを事前に集計し、集計済みデータをデータベースに格納することで、リアルタイムのデータ取得に比べて応答速度を短縮させました。

### 4. ディレクトリ構成の階層化

tests ディレクトリの配置を行い、モデル、ビュー、URL パターンなどに応じてテストを管理できるようにしました。テストスイートの構造が明確になり、テストの管理が容易になりました。

## トレードオフと意思決定

### 1. データの整形

Pandas を使用することで速度と柔軟性のトレードオフを考慮しました。Pandas はデータの取り扱いが容易で、プロジェクトの開発を迅速化できますが、大規模なデータセットの場合、パフォーマンスの問題が発生する可能性があります。

> 引用) pandas を大規模なデータセットで使用する際の最大の課題の 1 つは、ライブラリのメモリと速度の制限です。Apache Spark や Dask などの分散コンピューティングフレームワークの利用、GPU による計算、Amazon S3 などのクラウドサービスでの Pandas の利用など、pandas を大規模なデータセット用に拡張するためのソリューションがいくつか用意されています。さらに、HDF5 のようなキャッシュ戦略を用いることで、大規模なデータセットを扱う際の計算を高速化することも可能です。

### 2. データのインポート

データベースにインデックスを追加してクエリのパフォーマンスを向上させる必要がありますが、データの挿入速度が若干低下するため、適切なバランスを取りました。

初期データや初回集計データのインサートを行った後にインデックスを貼ることで、挿入速度を確保しました。

### 3. バッチ処理を介したデータ集計

リアルタイムのデータ集計に比べて、ユーザーがデータを要求した際に、すでに集計済みのデータを提供できるため、応答時間が短縮されます。また、データベースへの負荷軽減にもなっています。

デメリットとして、データの挿入から集計までの間に時間がかかるため、リアルタイム性が低下します。特に、こまめにデータを更新する場面では大きなデメリットになりますが、その場合はデータの集計も同様に、こまめに小出しして行なっていくことで解決できます。

## 今後の改善点

- データのインポートプロセスの自動化とスケジュール設定
- 大規模なデータセットに対するクエリの最適化
- データの集計処理の効率化
- キャッシュや非同期処理の導入
- ユーザーエクスペリエンスの向上
